import{Engine as e}from'@babylonjs/core/Engines/engine';import{Scene as t}from'@babylonjs/core/scene';import{Plane as r}from'@babylonjs/core/Maths/math.plane';import{Color4 as i,Color3 as s}from'@babylonjs/core/Maths/math.color';import{Matrix as n,Vector3 as o,Quaternion as a}from'@babylonjs/core/Maths/math.vector';import{Space as l,Axis as h}from'@babylonjs/core/Maths/math.axis';import{MeshBuilder as u}from'@babylonjs/core/Meshes/meshBuilder';import{TransformNode as c}from'@babylonjs/core/Meshes/transformNode';import'@babylonjs/core/Rendering/edgesRenderer';import{ArcRotateCamera as d}from'@babylonjs/core/Cameras/arcRotateCamera';import{PointLight as p}from'@babylonjs/core/Lights/pointLight';import{PointsCloudSystem as g}from'@babylonjs/core/Particles/pointsCloudSystem';import{Mesh as m}from'@babylonjs/core/Meshes/mesh';import'@babylonjs/core/Meshes/thinInstanceMesh';import{StandardMaterial as f}from'@babylonjs/core/Materials/standardMaterial';import{VertexBuffer as b}from'@babylonjs/core/Meshes/buffer';import{HighlightLayer as v}from'@babylonjs/core/Layers/highlightLayer';import{GridMaterial as y}from'@babylonjs/materials/grid/gridMaterial';import*as w from'd3';import{Texture as x}from'@babylonjs/core/Materials/Textures/texture';import{PointerEventTypes as C}from'@babylonjs/core/Events/pointerEvents';import{DynamicTexture as M}from'@babylonjs/core/Materials/Textures/dynamicTexture';function k(e){return k='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?e=>typeof e:e=>e&&'function'==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?'symbol':typeof e,k(e)}function A(e,t,r,i,s,n,o){try{var a=e[n](o),l=a.value}catch(e){return void r(e)}a.done?t(l):Promise.resolve(l).then(i,s)}function P(e){return function(){var t=this,r=arguments;return new Promise(((i,s)=>{var n=e.apply(t,r);function o(e){A(n,i,s,o,a,'next',e)}function a(e){A(n,i,s,o,a,'throw',e)}o(void 0)}))}}function S(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')}function F(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,'value'in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function I(e,t,r){return t&&F(e.prototype,t),r&&F(e,r),Object.defineProperty(e,'prototype',{writable:!1}),e}function R(e,t){if('function'!=typeof t&&null!==t)throw new TypeError('Super expression must either be null or a function');Object.defineProperty(e,'prototype',{value:Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),writable:!1}),t&&L(e,t)}function T(e){return T=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},T(e)}function L(e,t){return L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},L(e,t)}function B(e,t){if(t&&('object'==typeof t||'function'==typeof t))return t;if(void 0!==t)throw new TypeError('Derived constructors may only return object or undefined');return function(e){if(void 0===e)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return e}(e)}function O(e){var t=function(){if('undefined'==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if('function'==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(()=>{}))),!0}catch(e){return!1}}();return function(){var r,i=T(e);if(t){var s=T(this).constructor;r=Reflect.construct(i,arguments,s)}else r=i.apply(this,arguments);return B(this,r)}}function E(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:'undefined'!=typeof Symbol&&e[Symbol.iterator]||e['@@iterator'];if(null==r)return;var i,s,n=[],o=!0,a=!1;try{for(r=r.call(e);!(o=(i=r.next()).done)&&(n.push(i.value),!t||n.length!==t);o=!0);}catch(e){a=!0,s=e}finally{try{o||null==r.return||r.return()}finally{if(a)throw s}}return n}(e,t)||H(e,t)||function(){throw new TypeError('Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.')}()}function D(e){return function(e){if(Array.isArray(e))return j(e)}(e)||function(e){if('undefined'!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e['@@iterator'])return Array.from(e)}(e)||H(e)||function(){throw new TypeError('Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.')}()}function H(e,t){if(e){if('string'==typeof e)return j(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return'Object'===r&&e.constructor&&(r=e.constructor.name),'Map'===r||'Set'===r?Array.from(e):'Arguments'===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?j(e,t):void 0}}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function z(e,t,r){var i=Number(e.substring(1)),s=i||0;return r?s+t:s}function N(e,t,r,i){for(var s=t.x,n=t.z,o=t.y,a=s,l=n,h=o,u=0,c=0,d=0,p=e.some((e=>e.includes('G2'))),g=0;g<e.length;g++){var m=e[g];switch(m[0]){case'X':a=z(m,a,r);break;case'Y':l=z(m,l,r);break;case'Z':h=z(m,h,r);break;case'I':u=z(m,u,!1);break;case'J':c=z(m,c,!1);break;case'R':d=z(m,d,!1)}}if(d){var f=a-s,b=l-n,v=Math.pow(f,2)+Math.pow(b,2),y=Math.pow(d,2)-v/4;if(0==v||y<0)return{position:{x:a,y:h,z:l},points:[]};var w=Math.sqrt(y/v);(p&&d<0||!p&&d>0)&&(w=-w),u=f/2+b*w,c=b/2-f*w}else if(0==u&&0==c)return{position:{x:a,y:l,z:h},points:[]};var x,C=s==u&&n==l,M=s+u,k=n+c,A=Math.sqrt(u*u+c*c),P=Math.atan2(-c,-u),S=Math.atan2(l-k,a-M);C?x=2*Math.PI:(x=p?P-S:S-P)<0&&(x+=2*Math.PI);var F=A*x/i+.8;F<1&&(F=1);var I=x/F;I*=p?-1:1;for(var R=new Array,T=(o-h)/F,L=s,B=n,O=o,E=P,D=0;D<F-1;D++)E+=I,L=M+A*Math.cos(E),B=k+A*Math.sin(E),O+=T,R.push({x:L,y:O,z:B});return R.push({x:a,y:h,z:l}),{position:{x:a,y:h,z:l},points:R}}function V(){return new Promise((e=>setTimeout(e))).then((()=>Date.now()))}var G=function(){function e(){S(this,e),this.tool=0,this.start,this.end,this.extruding=!1,this.gcodeLineNumber=0,this.color,this.feedRate=0,this.layerHeight=0}return I(e,[{key:'length',value:function(){return this.distanceVector(this.start,this.end)}},{key:'renderLine',value:function(e){var t=[this.start,this.end],r=m.CreateLines('lines',t,e);r.enableEdgesRendering(),r.edgesWidth=10,r.edgesColor=new i(1,1,0,1)}},{key:'renderLineV2',value:function(){var e=u.CreateTube('tube',{path:[this.start,this.end],radius:.2,tesselation:4,sideOrientation:m.FRONTSIDE,updatable:!1});return e.doNotSyncBoundingInfo=!0,e}},{key:'distanceVector',value:function(e,t){var r=e.x-t.x,i=e.y-t.y,s=e.z-t.z;return Math.sqrt(r*r+i*i+s*s)}},{key:'renderLineV3',value:function(e,t){var r=this.distanceVector(this.start,this.end),i=Math.atan2(this.end.z-this.start.z,this.end.x-this.start.x);e.scaling.x=r,e.scaling.y=this.layerHeight,e.scaling.z=2*this.layerHeight,e.rotation.y=-i,e.position.x=this.start.x+r/2*Math.cos(i),e.position.y=this.start.y,e.position.z=this.start.z+r/2*Math.sin(i),e.color=this.color,e.materialIndex=t?1:0,e.props={gcodeLineNumber:this.gcodeLineNumber,originalColor:this.color}}},{key:'renderLinev4',value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;0===this.layerHeight&&(this.layerHeight=this.start.y);var r={},i=this.distanceVector(this.start,this.end),s=Math.atan2(this.end.z-this.start.z,this.end.x-this.start.x),l=i+t;return r.matrix=n.Compose(new o(l,this.layerHeight,e),a.FromEulerAngles(0,-s,0),new o(this.start.x+l/2*Math.cos(s),this.start.y,this.start.z+l/2*Math.sin(s))),r.color=this.color,r.props={gcodeLineNumber:this.gcodeLineNumber,originalColor:this.color},r}},{key:'renderParticle',value:function(e){e.position.x=this.start.x,e.position.y=this.start.y,e.position.z=this.start.z,e.color=this.color}},{key:'getPoints',value:function(){return{points:[this.start,this.end],colors:[this.color,this.color]}}},{key:'getColor',value:function(){return this.extruding?new i(1,1,1,1):new i(1,0,0,1)}},{key:'getVoxelSegments',value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,s=new Array,n=this.distanceVector(this.start,this.end);if(!(n<.1)){var a=Math.round(100*(n/(e/2)-1))/100,l=Math.atan2(this.end.z-this.start.z,this.end.x-this.start.x);i&&(this.start.y-=e/2,this.end.y-=e/2);var h=this.start.clone(),u=0;s.push(h.clone());var c=e/2*Math.cos(l),d=e/2*Math.sin(l),p=0;for(0!==a&&(p=(this.end.y-this.start.y)/a);u<a;){if(h.x+=c,h.y+=p,h.z+=d,s.push(h.clone()),r>e)for(var g=h.x-r;g<=h.x+r;g+=e)for(var m=h.z-r;m<h.z+r;m+=e)s.push(new o(g,h.y,m));u++}if(s.push(this.end.clone()),this.layerHeight>t&&i){for(var f=[],b=0;b<s.length;b++)for(var v=s[b],y=1;y<Math.ceil(this.layerHeight/t);y++)f.push(new o(v.x,v.y-y*t,v.z));s.push.apply(s,f)}return s}}}]),e}(),U=function(){function e(){S(this,e),this.name='',this.color=new i(0,0,1,1),this.diameter=.4,this.toolType=W.Extruder}return I(e,[{key:'colorString',get:function(){return this.color.toHexString()},set:function(e){this.color=i.FromHexString(e+'FF')}},{key:'isAdditive',value:function(){return this.toolType===W.Extruder}},{key:'getDiameter',value:function(){return this.diameter}},{key:'toJson',value:function(){return JSON.stringify(this)}}],[{key:'fromJson',value:function(t){var r;r='object'===k(t)?t:JSON.parse(t);var s=new e;return s.name=r.name,s.color=new i(r.color.r,r.color.g,r.color.b,r.color.a),s.diameter=parseFloat(r.diameter),s.toolType=r.toolType,s}}]),e}(),W={Extruder:'Extruder',Endmill:'Endmill'};new Array;var q,Q,Z,K=function(){function e(t,r,s,n,o){S(this,e),this.scene=t,this.specularColor=r,this.loadingProgressCallback=s,this.renderFuncs=n,this.solidMat,this.transparentMat,this.previousFilePosition=0,this.currentFilePosition=0,this.tools=o,this.scrubDistance=3e4,this.progressColor=new i(0,1,0,1),this.isLoading=!0,this.vertexAlpha=!1,this.forceRedraw=!1,this.material=null}return I(e,[{key:'updateFilePosition',value:function(e){this.previousFilePosition=this.currentFilePosition,this.currentFilePosition=e}},{key:'updateLiveTrackingShowSolid',value:function(e){this.liveTrackingShowSolid=e}}]),e}(),J=function(e){R(r,K);var t=O(r);function r(e,s,a,l,h,u){var c;return S(this,r),(c=t.call(this,e,s,a,l,h)).meshIndex=null!=u?u:0,c.lostInSpace=n.Identity().setTranslation(new o(1e4,1e4,1e4)),c.additiveColor=new i(0,1,0,.8),c}return I(r,[{key:'buildBox',value:function(){if(this.solidMat)try{this.solidMat.dispose(),this.solidMat=null}catch(e){console.warn('nothing to dispose')}if(this.transparentMat)try{this.transparentMat.dispose(),this.transparentMat=null}catch(e){console.warn('nothing to dispose')}var e=u.CreateBox('box',{width:1,height:1,depth:1,sideOrientation:m.FRONTSIDE},this.scene);return this.material=new f('mat',this.scene),this.material.specularColor=this.specularColor,e.material=this.material,this.vertexAlpha&&(e.hasVertexAlpha=!0,e.material.forceDepthWrite=!0,e.material.alpha=.99),e}},{key:'render',value:function(e){for(var t=this,r=new Array,i=new Array,s=this.vertexAlpha?.05:0,n=0;n<e.length;n++){var o=e[n],a=this.tools[o.tool];if(o.extruding){var l=o.renderLinev4(a.getDiameter(),.1),h={};h.matrix=l.matrix,h.color=l.color,r.push(h),i.push(l.props.gcodeLineNumber)}}for(var u=new Float32Array(16*r.length),c=new Float32Array(4*r.length),d=new Array,p=0;p<r.length;p++){var g=r[p];g.matrix.copyToArray(u,16*p),g.color.toArray(c,4*p),c[4*p+3]=s,d.push(!1)}var m=this.buildBox();m.thinInstanceSetBuffer('matrix',u,16),m.thinInstanceSetBuffer('color',c,4),m.thinInstanceRefreshBoundingInfo(),m.alphaIndex=this.meshIndex,m.renderingGroupId=2;var f=function(){for(var e=w,n=w,o=0;o<r.length;o++){var a=4*o;w?i[o]<t.currentFilePosition?(r[o].color.toArray(c,a),r[o].matrix.copyToArray(u,16*o),c[a+3]=1,d[o]=!0):(0==s?t.lostInSpace.copyToArray(u,16*o):r[o].matrix.copyToArray(u,16*o),c[a+3]=s,d[o]=!1):d[o]||(i[o]<t.currentFilePosition&&c[a+3]<.5?(t.progressColor.toArray(c,a),c[a+3]=.9,e=!0,r[o].matrix.copyToArray(u,16*o),n=!0):(c[a+3]>.5&&c[a+3]<1&&(c[a+3]+=.02),c[a+3]>=1&&!d[o]&&(r[o].color.toArray(c,a),c[a+3]=1,d[o]=!0,e=!0)))}e&&m.thinInstanceBufferUpdated('color'),n&&(m.thinInstanceBufferUpdated('matrix'),m.thinInstanceRefreshBoundingInfo())};if(0!=e.length){var b=e[0].gcodeLineNumber,v=e.slice(-1)[0].gcodeLineNumber,y=0,w=!1,x=Date.now(),C=function(){if(!(t.isLoading||Date.now()-x<200)){if(x=Date.now(),Math.abs(y-t.currentFilePosition)>t.scrubDistance||t.forceRedraw){w=!0,t.forceRedraw=!1,y=0;for(var e=0;e<d.length;e++)d[e]=!1;f()}else t.currentFilePosition>=b-3e4&&t.currentFilePosition<=v+3e4&&(w=!1,f());y=t.currentFilePosition}};this.renderFuncs.push(C),this.scene.registerBeforeRender(C)}}}]),r}(),X=function(e){R(r,K);var t=O(r);function r(e,s,a,l,h,u){var c;return S(this,r),(c=t.call(this,e,s,a,l,h)).meshIndex=null!=u?u:0,c.lostInSpace=n.Identity().setTranslation(new o(1e4,1e4,1e4)),c.additiveColor=new i(0,1,0,.8),c}return I(r,[{key:'buildCylinder',value:function(){if(this.solidMat)try{this.solidMat.dispose(),this.solidMat=null}catch(e){console.warn('nothing to dispose')}if(this.transparentMat)try{this.transparentMat.dispose(),this.transparentMat=null}catch(e){console.warn('nothing to dispose')}var e=u.CreateCylinder('box',{height:1,diameter:1});return e.locallyTranslate(new o(0,0,0)),e.rotate(new o(0,0,1),Math.PI/2,l.WORLD),e.bakeCurrentTransformIntoVertices(),this.material=new f('mat',this.scene),this.material.specularColor=this.specularColor,e.material=this.material,this.vertexAlpha&&(e.hasVertexAlpha=!0,e.material.forceDepthWrite=!0,e.material.alpha=.99),e}},{key:'render',value:function(e){for(var t=this,r=new Array,i=new Array,s=this.vertexAlpha?.05:0,n=0;n<e.length;n++){var o=e[n],a=this.tools[o.tool];if(o.extruding){var l=o.renderLinev4(a.getDiameter(),.1),h={};h.matrix=l.matrix,h.color=l.color,r.push(h),i.push(l.props.gcodeLineNumber)}}for(var u=new Float32Array(16*r.length),c=new Float32Array(4*r.length),d=new Array,p=0;p<r.length;p++){var g=r[p];g.matrix.copyToArray(u,16*p),g.color.toArray(c,4*p),c[4*p+3]=s,d.push(!1)}var m=this.buildCylinder();m.thinInstanceSetBuffer('matrix',u,16),m.thinInstanceSetBuffer('color',c,4),m.thinInstanceRefreshBoundingInfo(),m.alphaIndex=this.meshIndex,m.renderingGroupId=2;var f=function(){for(var e=w,n=w,o=0;o<r.length;o++){var a=4*o;w?i[o]<t.currentFilePosition?(r[o].color.toArray(c,a),r[o].matrix.copyToArray(u,16*o),c[a+3]=1,d[o]=!0):(0==s?t.lostInSpace.copyToArray(u,16*o):r[o].matrix.copyToArray(u,16*o),c[a+3]=s,d[o]=!1):d[o]||(i[o]<t.currentFilePosition&&c[a+3]<.5?(t.progressColor.toArray(c,a),c[a+3]=.9,e=!0,r[o].matrix.copyToArray(u,16*o),n=!0):(c[a+3]>.5&&c[a+3]<1&&(c[a+3]+=.02),c[a+3]>=1&&!d[o]&&(r[o].color.toArray(c,a),c[a+3]=1,d[o]=!0,e=!0)))}e&&m.thinInstanceBufferUpdated('color'),n&&(m.thinInstanceBufferUpdated('matrix'),m.thinInstanceRefreshBoundingInfo())};if(0!=e.length){var b=e[0].gcodeLineNumber,v=e.slice(-1)[0].gcodeLineNumber,y=0,w=!1,x=Date.now(),C=function(){if(!(t.isLoading||Date.now()-x<200)){if(x=Date.now(),Math.abs(y-t.currentFilePosition)>t.scrubDistance||t.forceRedraw){w=!0,t.forceRedraw=!1,y=0;for(var e=0;e<d.length;e++)d[e]=!1;f()}else t.currentFilePosition>=b-3e4&&t.currentFilePosition<=v+3e4&&(w=!1,f());y=t.currentFilePosition}};this.renderFuncs.push(C),this.scene.registerBeforeRender(C)}}}]),r}(),Y=I((function e(t,r){S(this,e),this.filePosition=t,this.add=r,this.complete=!1})),_=function(e){R(s,K);var t,r=O(s);function s(e,t,a,l,h,u,c){var d;return S(this,s),(d=r.call(this,e,t,a,l,h)).voxelWidth=parseFloat(u),d.voxelHeight=parseFloat(c),d.solidMat,d.transparentMat,d.hasSubtractive=!1,d.lostInSpace=n.Identity().setTranslation(new o(1e4,1e4,1e4)),d.clearColor=new i(1,0,0,0),d.additiveColor=new i(0,1,0,.8),d.subtractiveColor=new i(1,0,0,.8),d}return I(s,[{key:'buildBox',value:function(){if(this.solidMat)try{this.solidMat.dispose(),this.solidMat=null}catch(e){}if(this.transparentMat)try{this.transparentMat.dispose(),this.transparentMat=null}catch(e){}var e=u.CreateBox('box',{width:this.voxelWidth,height:this.voxelHeight,depth:this.voxelWidth},this.scene);return e.hasVertexAlpha=!0,e.updateFacetData=!0,this.material=new f('mat',this.scene),this.material.needDepthPrePass=!0,this.material.forceDepthWrite=!0,this.material.backFaceCulling=!1,e.material=this.material,e}},{key:'render',value:(t=P(regeneratorRuntime.mark((function e(t){var r,i,a,l,h,u,c,d,p,g,m,f,b,v,y,w,x,C,M,k,A,P=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(this.isLoading=!0,r=parseInt(300/this.voxelWidth)+1,i=r,a=parseInt(300/this.voxelHeight)+1,l=new Array(i),h=0;h<=a;h++)l[h]=new Object;u=0,c=new Date,d=0;case 10:if(!(d<t.length)){e.next=60;break}if(p=t[d],g=this.tools[p.tool],p.extruding){e.next=15;break}return e.abrupt('continue',57);case 15:if(void 0!==(m=p.getVoxelSegments(this.voxelWidth,this.voxelHeight,g.getDiameter()/2,g.isAdditive()))&&0!==m.length){e.next=18;break}return e.abrupt('continue',57);case 18:f=new Y(p.gcodeLineNumber,g.isAdditive()),b=0;case 20:if(!(b<m.length)){e.next=51;break}if(v=m[b],y=Math.floor(v.x/this.voxelWidth),w=Math.floor(v.y/this.voxelHeight),x=Math.floor(v.z/this.voxelWidth),w<0&&(w=0),w!=u&&g.isAdditive()&&(u=w),'Extruder'!==g.toolType){e.next=32;break}try{C=l[w][y][x]}catch(e){C=null}if(C)C.voxelEvents.push(f);else try{l[w].hasOwnProperty(y)||(l[w][y]={}),l[w][y][x]={color:p.color,voxelEvents:[f]}}catch(e){console.log(e),console.log(''.concat(y,'  ').concat(w,' ').concat(x))}e.next=48;break;case 32:this.hasSubtractive=!0,M=w;case 34:if(!(M<=u+1)){e.next=48;break}e.prev=35,l[M][y][x]?l[M][y][x].voxelEvents.push(f):(l[M].hasOwnProperty(y)||(l[M][y]={}),l[M][y][x]={color:p.color,voxelEvents:[f]}),e.next=45;break;case 39:if(e.prev=39,e.t0=e.catch(35),!(M<0)){e.next=43;break}return e.abrupt('continue',45);case 43:l[M].hasOwnProperty(y)||(l[M][y]={}),l[M][y][x]={color:p.color,voxelEvents:[f]};case 45:M++,e.next=34;break;case 48:b++,e.next=20;break;case 51:if(t[d]=null,!(d%1e4==0||new Date-c>5e3)){e.next=57;break}return c=new Date,this.loadingProgressCallback(d/t.length,'Generating Voxel Map...'),e.next=57,V();case 57:d++,e.next=10;break;case 60:this.loadingProgressCallback(d/t.length,'Rendering Voxel...'),k=regeneratorRuntime.mark((function e(t){var r,i,a,h,d,p,g,m,f,b,v,y,w,x,C,M,k,A,S,F,I,R,T,L,B,O,H,j,z;return regeneratorRuntime.wrap((e=>{for(;;)switch(e.prev=e.next){case 0:if(r=[],void 0!==l[t]){e.next=3;break}return e.abrupt('return','continue');case 3:for(i=999999999999,a=-999999999999,h=[],d=0,p=Object.entries(l[t]);d<p.length;d++)for(g=E(p[d],2),m=g[0],f=g[1],b=0,v=Object.entries(f);b<v.length;b++)w=E(v[b],2),x=w[0],(C=w[1]).voxelEvents[0].filePosition<i&&(i=C.voxelEvents[0].filePosition),C.voxelEvents.slice()[0].filePosition>a&&(a=C.voxelEvents[0].filePosition),(y=h).push.apply(y,D(C.voxelEvents.map((e=>e.filePosition)))),C.color.a=1,(M={matrix:n.Identity(),color:C.color.clone(),voxelEvents:C.voxelEvents,lastDrawnCount:0}).matrix.setTranslation(new o(m*P.voxelWidth,t*P.voxelHeight,x*P.voxelWidth)),r.push(M);for(k=0,h=h.sort(((e,t)=>e-t)),h=D(new Set(h)),r.length,l[t]=null,(A=P.buildBox()).alphaIndex=t,A.renderingGroupId=1,S=new Float32Array(16*r.length),F=new Float32Array(4*r.length),I=0;I<r.length;I++){R=r[I];try{R&&(R.matrix.copyToArray(S,16*I),R.color.toArray(F,4*I),P.hasSubtractive||delete R.matrix)}catch(e){console.log(e)}}if(A.thinInstanceSetBuffer('matrix',S,16),A.thinInstanceSetBuffer('color',F,4),A.thinInstanceRefreshBoundingInfo(),T=()=>{for(var e=!1,t=!1,i=0;i<r.length;i++){var n=r[i];O&&(P.clearColor.toArray(F,4*i),P.hasSubtractive&&P.lostInSpace.copyToArray(S,16*i));var o=n.voxelEvents.filter((e=>e.filePosition<P.currentFilePosition)).slice(-1)[0];null!=o&&(o.add?(o.filePosition>L&&o.filePosition<=P.currentFilePosition&&(n.lastDrawnCount=0,P.hasSubtractive&&n.matrix.copyToArray(S,16*i)),O&&(n.lastDrawnCount=s.drawDelay),n.lastDrawnCount<s.drawDelay?(P.additiveColor.toArray(F,4*i),n.lastDrawnCount++):(n.color.toArray(F,4*i),P.hasSubtractive&&n.matrix.copyToArray(S,16*i))):(o.filePosition>=L&&o.filePosition<=P.currentFilePosition&&(n.lastDrawnCount=0),O&&(n.lastDrawnCount=s.drawDelay),n.lastDrawnCount<s.drawDelay?(P.subtractiveColor.toArray(F,4*i),n.lastDrawnCount++):(e=!0,P.clearColor.toArray(F,4*i),P.hasSubtractive&&P.lostInSpace.copyToArray(S,16*i),t=!0)))}A.thinInstanceBufferUpdated('color'),e&&A.thinInstanceRefreshBoundingInfo(),t&&(A.thinInstanceRefreshBoundingInfo(),A.thinInstanceBufferUpdated('matrix'))},L=0,B=!0,O=!1,H=Number.MAX_VALUE,j=Date.now(),z=()=>{if(!(P.isLoading||Date.now()-j<200)){if(j=Date.now(),Math.abs(L-P.currentFilePosition)>P.scrubDistance||B||P.forceRedraw){k=0,O=!0,P.forceRedraw=!1;for(var e=0;e<r.length;e++)r[e].voxelEvents.forEach((e=>e.complete=!1));T(),B=!1}else if(k<h.length-1&&h[k]<P.currentFilePosition){O=!1,H=0,T();for(var t=k;t<h.length&&(k=t,!(h[t]>P.currentFilePosition));t++);}else H<10&&(H++,T());L=P.currentFilePosition}},P.loadingProgressCallback&&P.loadingProgressCallback(t/u,'Rendering Voxels...'),P.renderFuncs.push(z),P.scene.registerBeforeRender(z),!(new Date-c>1e3)){e.next=36;break}return c=new Date,e.next=36,V();case 36:case'end':return e.stop()}}),e)})),A=0;case 64:if(!(A<u)){e.next=72;break}return e.delegateYield(k(A),'t1',66);case 66:if('continue'!==e.t1){e.next=69;break}return e.abrupt('continue',69);case 69:A++,e.next=64;break;case 72:this.isLoading=!1,this.loadingProgressCallback(1),l=null;case 75:case'end':return e.stop()}}),e,this,[[35,39]])}))),function(e){return t.apply(this,arguments)})}]),s}();Z=5,(Q='drawDelay')in(q=_)?Object.defineProperty(q,Q,{value:Z,enumerable:!0,configurable:!0,writable:!0}):q[Q]=Z;var $=function(e){R(r,K);var t=O(r);function r(e,s,n,o,a,l){var h;return S(this,r),(h=t.call(this,e,s,n,o,a)).meshIndex=null!=l?l:0,h.additiveColor=new i(0,1,0,.8),h.travels=!1,h}return I(r,[{key:'render',value:function(e){var t=this,r=new Array;this.renderMode='Line Rendering';for(var i=[],s=[],n=[],o=[],a=this.vertexAlpha?.25:0,l=0;l<e.length;l++){var h=e[l],c=this.tools[h.tool];r.push(h.gcodeLineNumber);var d=h.getPoints(this.scene);i.push(d.points),s.push(d.colors),n.push(c.isAdditive()&&!this.travels),o.push(!1)}var p=u.CreateLineSystem(this.travels?'travels':'lineMesh',{lines:i,colors:s,updatable:!0},this.scene);i=null,p.isVisible=!0,p.isPickable=!1,p.markVerticesDataAsUpdatable(b.ColorKind),this.material=new f('m',this.scene),p.material=this.material,p.material.backFaceCulling=!1,p.material.forceDepthWrite=!0,p.material.specularColor=this.specularColor,p.alphaIndex=this.meshIndex,p.renderingGroupId=2;var g=r[0],m=r.slice(-1)[0],v=0,y=!1,w=0,x=function(){var e=p.getVerticesData(b.ColorKind);if(e){var i=-1,l=-1;if(y){for(var h=0;h<r.length;h++){var u=8*h;t.travels?(e[u+3]=0,e[u+7]=0,o[h]=r[h]<t.currentFilePosition):r[h]<t.currentFilePosition?(s[h][0].toArray(e,u),s[h][1].toArray(e,u+4),e[u+3]=n[h]?1:0,e[u+7]=n[h]?1:0,o[h]=!0):(e[u+3]=n[h]?a:0,e[u+7]=n[h]?a:0,o[h]=!1)}w=0,p.updateVerticesData(b.ColorKind,e,!0)}for(var c=w;c<r.length;c++)r[c]<=t.currentFilePosition&&(i=c),r[c]<=t.currentFilePosition+t.lookAheadLength&&(l=c);for(var d=o.findIndex((e=>0==e));d<i;d++){var g=8*d;if(n[d]){if(o[d])continue;e[g+3]<=.5?(e[g]=t.progressColor.r,e[g+1]=t.progressColor.g,e[g+2]=t.progressColor.b,e[g+3]=.9,e[g+4]=t.progressColor.r,e[g+5]=t.progressColor.g,e[g+6]=t.progressColor.b,e[g+7]=.9):e[g+3]<1?(e[g+3]+=.02,e[g+7]+=.02):e[g+3]>=1&&(e[g]=s[d][0].r,e[g+1]=s[d][0].g,e[g+2]=s[d][0].b,e[g+3]=1,e[g+4]=s[d][1].r,e[g+5]=s[d][1].g,e[g+6]=s[d][1].b,e[g+7]=1,o[d]=!0)}else{if(o[d])continue;0===e[g+3]?(e[g]=1,e[g+1]=0,e[g+2]=0,e[g+3]=.9,e[g+4]=1,e[g+5]=0,e[g+6]=0,e[g+7]=.9):e[g+3]<1?(e[g+3]+=.02,e[g+7]+=.02):(e[g+3]=1e-4,e[g+7]=1e-4,o[d]=!0)}w=d}for(var m=i;m<l;m++){var f=8*m;e[f+3]=1,e[f+7]=1}p.updateVerticesData(b.ColorKind,e,!0)}else console.log('Error')},C=Date.now(),M=function(){if(!(t.isLoading||Date.now()-C<200)){if(C=Date.now(),Math.abs(v-t.currentFilePosition)>t.scrubDistance||t.forceRedraw){t.forceRedraw=!1,y=!0;for(var e=0;e<o.length;e++)o[e]=!1;w=0,v=0,x()}else t.currentFilePosition>=g-3e4&&t.currentFilePosition<=m+3e4&&(y=!1,x());v=t.currentFilePosition}};this.renderFuncs.push(M),this.scene.registerBeforeRender(M)}}]),r}(),ee=function(){function e(){S(this,e),this.feature=null,this.perimeter=!0,this.support=!1,this.missingFeatures=[]}return I(e,[{key:'isTypeComment',value:function(e){}},{key:'getFeatureColor',value:function(e){}},{key:'isPerimeter',value:function(){return this.perimeter}},{key:'isSupport',value:function(){return this.support}},{key:'reportMissingFeature',value:function(e){this.missingFeatures.includes(e)||(console.error('Missing feature '.concat(e)),this.missingFeatures.push(e))}}]),e}(),te=function(e){R(r,ee);var t=O(r);function r(){var e;return S(this,r),(e=t.call(this)).featureList={Perimeter:{color:new i(1,.9,.3,1),perimeter:!0,support:!1},'External perimeter':{color:new i(1,.5,.2,1),perimeter:!0,support:!1},'Internal infill':{color:new i(.59,.19,.16,1),perimeter:!1,support:!1},'Solid infill':{color:new i(.59,.19,.8,1),perimeter:!0,support:!1},'Top solid infill':{color:new i(.95,.25,.25,1),perimeter:!0,support:!1},'Bridge infill':{color:new i(.3,.5,.73,1),perimeter:!1,support:!1},'Gap fill':{color:new i(1,1,1,1),perimeter:!1,support:!1},Skirt:{color:new i(0,.53,.43,1),perimeter:!1,support:!1},'Skirt/Brim':{color:new i(0,.53,.43,1),perimeter:!1,support:!1},'Supported material':{color:new i(0,1,0,1),perimeter:!1,support:!0},'Supported material interface':{color:new i(0,.5,0,1),perimeter:!1,support:!0},Custom:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1},Unknown:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1},'Support material':{color:new i(.5,.5,.5,1),perimeter:!1,support:!0},'Support material interface':{color:new i(.5,.5,.5,1),perimeter:!1,support:!0},'Overhang perimeter':{color:new i(.5,.5,.5,1),perimeter:!0,support:!1},'Wipe tower':{color:new i(.5,.5,.5,1),perimeter:!0,support:!1}},e}return I(r,[{key:'isTypeComment',value:function(e){return!!e.trim().startsWith(';TYPE:')&&(this.feature=e.substring(6).trim(),!0)}},{key:'getFeatureColor',value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch(e){this.reportMissingFeature(this.feature)}return this.featureList.Unknown.color}},{key:'isPerimeter',value:function(){try{return this.featureList[this.feature].perimeter}catch(e){return this.reportMissingFeature(this.feature),!0}}},{key:'isSupport',value:function(){try{return this.featureList[this.feature].support}catch(e){return this.reportMissingFeature(this.feature),!1}}}]),r}(),re=function(e){R(r,ee);var t=O(r);function r(){var e;return S(this,r),(e=t.call(this)).featureList={SKIN:{color:new i(1,.9,.3,1),perimeter:!0,support:!1},'WALL-OUTER':{color:new i(1,.5,.2,1),perimeter:!0,support:!1},'WALL-INNER':{color:new i(.59,.19,.16,1),perimeter:!1,support:!1},FILL:{color:new i(.95,.25,.25,1),perimeter:!1,support:!1},SKIRT:{color:new i(0,.53,.43,1),perimeter:!1,support:!1},SUPPORT:{color:new i(0,.53,.43,1),perimeter:!1,support:!0},CUSTOM:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1},UNKNOWN:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1}},e}return I(r,[{key:'isTypeComment',value:function(e){return!!e.trim().startsWith(';TYPE:')&&(this.feature=e.substring(6).trim(),!0)}},{key:'getFeatureColor',value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch(e){this.reportMissingFeature(this.feature)}return this.featureList.UNKNOWN}},{key:'isPerimeter',value:function(){try{return this.featureList[this.feature].perimeter}catch(e){return this.reportMissingFeature(this.feature),!0}}},{key:'isSupport',value:function(){try{return this.featureList[this.feature].support}catch(e){return this.reportMissingFeature(this.feature),!1}}}]),r}(),ie=function(e){R(r,ee);var t=O(r);function r(){var e;return S(this,r),(e=t.call(this)).featureList={Perimeter:{color:new i(1,.9,.3,1),perimeter:!0,support:!1},'External perimeter':{color:new i(1,.5,.2,1),perimeter:!0,support:!1},'Internal infill':{color:new i(.59,.19,.16,1),perimeter:!1,support:!1},'Solid infill':{color:new i(.59,.19,.8,1),perimeter:!0,support:!1},'Top solid infill':{color:new i(.95,.25,.25,1),perimeter:!0,support:!1},'Bridge infill':{color:new i(.3,.5,.73,1),perimeter:!1,support:!1},'Gap fill':{color:new i(1,1,1,1),perimeter:!1,support:!1},Skirt:{color:new i(0,.53,.43,1),perimeter:!1,support:!1},'Skirt/Brim':{color:new i(0,.53,.43,1),perimeter:!1,support:!1},'Supported material':{color:new i(0,1,0,1),perimeter:!1,support:!0},'Supported material interface':{color:new i(0,.5,0,1),perimeter:!1,support:!0},Custom:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1},Unknown:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1},'Support material':{color:new i(.5,.5,.5,1),perimeter:!1,support:!0},'Support material interface':{color:new i(.5,.5,.5,1),perimeter:!1,support:!0},'Overhang perimeter':{color:new i(.5,.5,.5,1),perimeter:!0,support:!1},'Wipe tower':{color:new i(.5,.5,.5,1),perimeter:!0,support:!1}},e}return I(r,[{key:'isTypeComment',value:function(e){return!!e.trim().startsWith(';TYPE:')&&(this.feature=e.substring(6).trim(),!0)}},{key:'getFeatureColor',value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch(e){this.reportMissingFeature(this.feature)}return this.featureList.Unknown.color}},{key:'isPerimeter',value:function(){try{return this.featureList[this.feature].perimeter}catch(e){return this.reportMissingFeature(this.feature),!0}}},{key:'isSupport',value:function(){try{return this.featureList[this.feature].support}catch(e){return this.reportMissingFeature(this.feature),!1}}}]),r}(),se=function(e){R(r,ee);var t=O(r);function r(){var e;return S(this,r),(e=t.call(this)).featureList={'WALL-OUTER':{color:new i(.47,.18,.18,1),perimeter:!0,support:!1},'WALL-INNER':{color:new i(0,.55,0,1),perimeter:!1,support:!1},FILL:{color:new i(.9,.2,.2,1),perimeter:!1,support:!1},'SOLID-FILL':{color:new i(.95,.25,.25,1),perimeter:!1,support:!1},BRIDGE:{color:new i(.9,.15,.195,1),perimeter:!1,support:!1},SKIRT:{color:new i(.31,.12,.33,1),perimeter:!1,support:!1},SUPPORT:{color:new i(0,.53,.43,1),perimeter:!1,support:!0},'DENSE-SUPPORT':{color:new i(0,.28,.55,1),perimeter:!1,support:!0},RAFT:{color:new i(.59,.49,.2,1),perimeter:!1,support:!1},CUSTOM:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1},UNKNOWN:{color:new i(.5,.5,.5,1),perimeter:!1,support:!1}},e}return I(r,[{key:'isTypeComment',value:function(e){return!!e.trim().startsWith(';TYPE:')&&(this.feature=e.substring(6).trim(),!0)}},{key:'getFeatureColor',value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch(e){this.reportMissingFeature(this.feature)}return this.featureList.UNKNOWN.color}},{key:'isPerimeter',value:function(){try{return this.featureList[this.feature].perimeter}catch(e){return this.reportMissingFeature(this.feature),!0}}},{key:'isSupport',value:function(){try{return this.featureList[this.feature].support}catch(e){return this.reportMissingFeature(this.feature),!1}}}]),r}(),ne=function(){function e(){S(this,e)}return I(e,null,[{key:'getSlicer',value:function(e){if(!e)return null;var t=e.substring(0,1e4);return t.includes('; generated by PrusaSlicer')?new te:t.includes(';Generated with Cura_SteamEngine')?new re:t.includes('; generated by SuperSlicer')?new ie:t.includes('Sliced by ideaMaker')?new se:null}}]),e}(),oe={Block:1,Line:2,Point:3,Max:4,Voxel:5},ae={Color:0,Feed:1,Feature:2},le=function(){function e(){S(this,e),this.currentPosition=new o(0,0,0),this.currentColor=new i(.25,.25,.25,1),this.currentTool=0,this.renderVersion=oe.Line,this.absolute=!0,this.lines=[],this.travels=[],this.sps,this.maxHeight=0,this.minHeight=0,this.lineCount=0,this.renderMode='',this.extruderCount=10,this.layerDictionary={},this.previousLayerHeight=0,this.currentLayerHeight=0,this.liveTracking=!1,this.liveTrackingShowSolid='true'===localStorage.getItem('showSolid'),this.materialTransparency=.3,this.gcodeLineIndex=[],this.gcodeFilePosition=0,this.refreshTime=200,this.timeStamp,this.lineLengthTolerance=.05,this.tools=new Array;for(var t=['#00FFFF','#FF00FF','#FFFF00','#000000','#FFFFFF'],r=0;r<5;r++){var n=new U;n.color=i.FromHexString(t[r]),n.diameter=.4,this.tools.push(n)}this.progressColor=new i(0,1,0,1),this.lineMeshIndex=0,this.scene,this.renderFuncs=new Array,this.meshBreakPoint=2e4,this.feedRateTrimming=!1,this.currentFeedRate=0,this.feedValues=0,this.numChanges=0,this.avgFeed=0,this.maxFeedRate=0,this.minFeedRate=Number.MAX_VALUE,this.underspeedPercent=1,this.colorMode=Number.parseInt(localStorage.getItem('processorColorMode')),this.colorMode||this.setColorMode(ae.Color),this.minColorRate=Number.parseInt(localStorage.getItem('minColorRate')),this.minColorRate||(this.minColorRate=1200,localStorage.setItem('minColorRate',this.minColorRate)),this.maxColorRate=Number.parseInt(localStorage.getItem('maxColorRate')),this.maxColorRate||(this.maxColorRate=3600,localStorage.setItem('maxColorRate',this.maxColorRate)),this.minFeedColorString=localStorage.getItem('minFeedColor'),this.minFeedColorString||(this.minFeedColorString='#0000FF'),this.minFeedColor=i.FromHexString(this.minFeedColorString.padEnd(9,'F')),this.maxFeedColorString=localStorage.getItem('maxFeedColor'),this.maxFeedColorString||(this.maxFeedColorString='#FF0000'),this.maxFeedColor=i.FromHexString(this.maxFeedColorString.padEnd(9,'F')),this.everyNthRow=0,this.currentRowIdx=-1,this.currentZ=0,this.renderTravels=!0,this.vertexAlpha=!1,this.forceWireMode='true'===localStorage.getItem('forceWireMode'),this.spreadLines=!1,this.spreadLineAmount=10,this.debug=!1,this.specularColor=new s(0,0,0),this.lookAheadLength=500,this.cancelLoad=!1,this.loadingProgressCallback,this.hasSpindle=!1,this.voxelWidth=1,this.voxelHeight=1,this.forceVoxels=!1,this.renderInstances=new Array,this.meshIndex=0,this.highQualityExtrusion=!1,this.perimeterOnly=!1,this.lastUpdate=Date.now(),this.treatG1Extrusion=!1}var t,r,n,a,l;return I(e,[{key:'doUpdate',value:function(){this.lastUpdate=Date.now()}},{key:'setProgressColor',value:function(e){var t=this;this.progressColor=i.FromHexString(e.padEnd(9,'F')),this.renderInstances.forEach((e=>e.progressColor=t.progressColor))}},{key:'getMaxHeight',value:function(){return this.maxHeight+1}},{key:'getMinHeight',value:function(){return this.minHeight}},{key:'setRenderQualitySettings',value:function(e,t){if(this.forceVoxels)return this.renderVersion=oe.Voxel,void(this.meshBreakPoint=Number.MAX_VALUE);void 0===t&&(t=1);var r=0,i=this.forceWireMode?2:1,s=2;switch(this.refreshTime=5e3,this.everyNthRow=1,this.renderTravels=!0,t){case 1:i=2,this.refreshTime=3e4,r=25e3,s=50,this.renderTravels=!1;break;case 2:i=2,this.refreshTime=3e4,r=5e5,s=10,this.renderTravels=!1;break;case 3:r=1e6,s=3;break;case 4:r=15e6,s=2;break;case 5:r=25e6;break;default:return this.renderVersion=oe.Block,void(this.everyNthRow=1)}for(var n=i;n<4;n++){var o=void 0;switch(n){case 1:o=24;break;case 2:o=2;break;case 3:o=1}for(var a=this.everyNthRow;a<=s;a++)if(this.debug&&console.log('Mode: '+n+'  NRow: '+a+'   vertexcount: '+e*o/a),e*o/a<r)return this.renderVersion=n,void(this.everyNthRow=a)}}},{key:'initVariables',value:function(){this.currentPosition=new o(0,0,0),this.cancelLoad=!1,this.absolute=!0,this.currentZ=0,this.currentRowIdx=-1,this.gcodeLineIndex=[],this.lineMeshIndex=0,this.lastExtrudedZHeight=0,this.previousLayerHeight=0,this.currentLayerHeight=0,this.minFeedRate=Number.MAX_VALUE,this.maxFeedRate=0,this.hasSpindle=!1,this.currentColor=new i(1,1,1,1),this.slicer=null,this.skip=!1,this.isSupport=!1,this.currentTool=0}},{key:'processGcodeFile',value:(l=P(regeneratorRuntime.mark((function e(t,r,i){var s,n,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.initVariables(),this.slicer=ne.getSlicer(t),this.meshIndex=0,this.currentTool=0,null==r&&(r=4),t&&0!==t.length){e.next=7;break}return e.abrupt('return');case 7:n=t.split('\n'),'function'==typeof i&&i(),this.lineCount=n.length,this.debug&&console.info('Line Count : '.concat(this.lineCount)),this.setRenderQualitySettings(this.lineCount,r),0==this.tools.length&&this.tools.push(new U),this.currentColor=null!==(s=this.tools[0].color)&&void 0!==s?s:(new U).color,n.reverse(),o=0,this.timeStamp=Date.now();case 17:if(!n.length){e.next=34;break}if(!this.cancelLoad){e.next=21;break}return this.cancelLoad=!1,e.abrupt('return');case 21:if(a=n.pop(),o+=a.length+1,a.trim(),this.perimeterOnly&&this.slicer&&this.slicer.isTypeComment(a)&&this.slicer.isPerimeter()&&(this.currentColor=this.slicer.getFeatureColor()),a.startsWith(';')?this.slicer&&this.slicer.isTypeComment(a)&&(this.isSupport=this.slicer.isSupport(),this.colorMode===ae.Feature&&(this.currentColor=this.slicer.getFeatureColor())):this.processLine(a,o),!(Date.now()-this.timeStamp>10)){e.next=31;break}return this.loadingProgressCallback&&this.loadingProgressCallback(o/t.length,'Loading File...'),e.next=30,V();case 30:this.timeStamp=e.sent;case 31:this.doUpdate(),e.next=17;break;case 34:if(!this.renderTravels){e.next=37;break}return e.next=37,this.createTravelLines(this.scene);case 37:this.loadingProgressCallback&&this.loadingProgressCallback(1),t={};case 39:case'end':return e.stop()}}),e,this)}))),function(e,t,r){return l.apply(this,arguments)})},{key:'loadingComplete',value:function(){this.renderInstances.forEach((e=>e.isLoading=!1))}},{key:'processLine',value:(a=P(regeneratorRuntime.mark((function e(t,r){var n,a,l,h,u,c,d,p,g,m,f,b,v,y,w,x,C,M,k,A,P,S,F,I,R,T,L,B,O,E=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=t.indexOf(';'))>-1&&(t=t.substring(0,n-1).trim()),t=t.toUpperCase(),null==(l=t.match(/[GM]+[0-9.]+/))){e.next=99;break}l=l.filter((e=>e.startsWith('G')||e.startsWith('M'))),e.t0=l[0],e.next='G0'===e.t0||'G1'===e.t0?9:'G2'===e.t0||'G3'===e.t0?53:'G28'===e.t0?62:'G90'===e.t0?65:'G91'===e.t0?67:'G92'===e.t0?69:'S'===e.t0?70:'M3'===e.t0||'M4'===e.t0?72:'M567'===e.t0?77:'M600'===e.t0?95:97;break;case 9:a=t.split(/(?=[GXYZEFUV])/),(c=new G).tool=this.currentTool,c.gcodeLineNumber=r,c.start=this.currentPosition.clone(),c.layerHeight=this.currentLayerHeight-this.previousLayerHeight,'G1'==l[0].toUpperCase()&&(null===(h=!(null!==(u=this.tools[this.currentTool])&&void 0!==u&&u.isAdditive()))||void 0===h||h||this.treatG1Extrusion)&&(c.extruding=!0,c.color=null!==(d=null===(p=this.tools[this.currentTool])||void 0===p?void 0:p.color.clone())&&void 0!==d?d:this.tools[0].color.clone(),this.maxHeight=this.currentPosition.y),g=1;case 17:if(!(g<a.length)){e.next=40;break}m=a[g],e.t1=m[0],e.next='X'===e.t1?22:'Y'===e.t1?24:'Z'===e.t1?26:'E'===e.t1?30:'F'===e.t1?32:37;break;case 22:return this.currentPosition.x=this.absolute?Number(m.substring(1)):this.currentPosition.x+Number(m.substring(1)),e.abrupt('break',37);case 24:return this.currentPosition.z=this.absolute?Number(m.substring(1)):this.currentPosition.z+Number(m.substring(1)),e.abrupt('break',37);case 26:return this.currentPosition.y=this.absolute?Number(m.substring(1)):this.currentPosition.y+Number(m.substring(1)),this.currentPosition.y<this.minHeight&&(this.minHeight=this.currentPosition.y),this.spreadLines&&(this.currentPosition.y*=this.spreadLineAmount),e.abrupt('break',37);case 30:return Number(m.substring(1))>0&&(c.extruding=!0,this.maxHeight=this.currentPosition.y),e.abrupt('break',37);case 32:return this.currentFeedRate=Number(m.substring(1)),this.currentFeedRate>this.maxFeedRate&&(this.maxFeedRate=this.currentFeedRate),this.currentFeedRate<this.minFeedRate&&(this.minFeedRate=this.currentFeedRate),this.colorMode===ae.Feed&&(f=(this.currentFeedRate-this.minColorRate)/(this.maxColorRate-this.minColorRate),this.currentColor=f>=1?this.maxFeedColor:f<=0?this.minFeedColor:i.Lerp(this.minFeedColor,this.maxFeedColor,f)),e.abrupt('break',37);case 37:g++,e.next=17;break;case 40:if(!c.extruding||!this.skip){e.next=42;break}return e.abrupt('return');case 42:if(c.end=this.currentPosition.clone(),this.debug,this.feedRateTrimming&&(this.feedValues+=this.currentFeedRate,this.numChanges++,this.avgFeed=this.feedValues/this.numChanges*this.underspeedPercent),!(this.everyNthRow>1&&c.extruding)){e.next=49;break}if(this.currentPosition.y>this.currentZ&&(this.currentRowIdx++,this.currentRowIdx%3==0&&this.currentRowIdx++,this.currentZ=this.currentPosition.y),!(this.currentRowIdx%this.everyNthRow==0&&this.currentRowIdx>2)){e.next=49;break}return e.abrupt('return');case 49:return b=this.hasSpindle&&'G1'===l[0],v=c.length()>=this.lineLengthTolerance,b||v&&c.extruding?(null==this.currentColor&&(this.currentColor=new i(1,1,1,1)),c.color=this.currentColor.clone(),this.lines.push(c),this.currentPosition.y>this.currentLayerHeight&&!this.isSupport&&(this.previousLayerHeight=this.currentLayerHeight,this.currentLayerHeight=this.currentPosition.y)):this.renderTravels&&!c.extruding&&(c.color=new i(1,0,0,1),this.travels.push(c)),e.abrupt('break',97);case 53:return a=t.split(/(?=[GXYZIJFRE])/),y=t.indexOf('E')>0,w=a.filter((e=>'G2'===e)),x=N(a,this.currentPosition,!this.absolute,1),C=this.currentPosition.clone(),x.points.forEach(((e,t)=>{var s=new G;s.tool=E.currentTool,s.gcodeLineNumber=r,s.layerHeight=E.currentLayerHeight-E.previousLayerHeight,s.start=C.clone(),s.end=new o(e.x,e.y,e.z),s.color=E.currentColor.clone(),s.extruding=y,E.debug&&(s.color=w?new i(0,1,1,1):new i(1,1,0,1),0==t&&(s.color=new i(0,1,0,1))),C=s.end.clone(),E.debug&&console.log(s),E.lines.push(s)})),this.currentPosition=new o(C.x,C.y,C.z),this.currentPosition.y>this.currentLayerHeight&&!this.isSupport&&(this.previousLayerHeight=this.currentLayerHeight,this.currentLayerHeight=this.currentPosition.y),e.abrupt('break',97);case 62:return 1==(a=t.split(/(?=[GXYZ])/)).length?this.currentPosition=new o(0,0,0):(a.some((e=>'X'===e.trim()))&&(this.currentPosition.x=0),a.some((e=>'Y'===e.trim()))&&(this.currentPosition.z=0),a.some((e=>'Z'===e.trim()))&&(this.currentPosition.y=0)),e.abrupt('break',97);case 65:return this.absolute=!0,e.abrupt('break',97);case 67:return this.absolute=!1,e.abrupt('break',97);case 69:return e.abrupt('break',97);case 70:return this.hasSpindle=!0,e.abrupt('break',97);case 72:return M=t.split(/(?=[SM])/),(k=(k=M.filter((e=>e.startsWith('S'))))[0]?Number(k[0].substring(1)):0)>0&&(this.hasSpindle=!0),e.abrupt('break',97);case 77:if(A=t.split(/(?=[PE])/),this.colorMode!==ae.Feed){e.next=80;break}return e.abrupt('break',97);case 80:P=1;case 81:if(!(P<A.length)){e.next=92;break}S=A[P],F=[1,1,1],e.t2=S[0],e.next='E'===e.t2?87:89;break;case 87:return this.extruderPercentage=S.substring(1).split(':'),e.abrupt('break',89);case 89:P++,e.next=81;break;case 92:for(I=0;I<this.extruderPercentage.length;I++)F[0]-=(1-this.tools[I].color.r)*this.extruderPercentage[I],F[1]-=(1-this.tools[I].color.g)*this.extruderPercentage[I],F[2]-=(1-this.tools[I].color.b)*this.extruderPercentage[I];return this.currentColor=new i(F[0],F[1],F[2],.1),e.abrupt('break',97);case 95:try{this.currentTool++,this.currentTool>=this.tools.length&&(this.currentTool=0),this.colorMode!==ae.Feed&&(this.currentColor=this.tools[this.currentTool].color.clone())}catch(e){console.log(e)}return e.abrupt('break',97);case 97:e.next=101;break;case 99:t.startsWith('T')&&(R=Number.parseInt(t.substring(1)),isNaN(R)||(this.currentPosition.z+=10,this.currentTool=R,this.currentTool>=this.tools.length?this.currentTool=this.currentTool%this.tools.length:O<0&&(this.currentTool=0,O=0),this.colorMode!==ae.Feed&&(O=Number(t.substring(1))%this.extruderCount,this.currentColor=null!==(T=null===(L=this.tools[O])||void 0===L||null===(B=L.color)||void 0===B?void 0:B.clone())&&void 0!==T?T:new s(1,0,0)))),this.debug&&console.log(t);case 101:if(!(this.lines.length>=this.meshBreakPoint)){e.next=108;break}return e.next=104,this.createMesh(this.scene);case 104:return e.next=106,V();case 106:this.doUpdate(),this.meshIndex++;case 108:case'end':return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:'renderPointMode',value:function(e){var t=this.lineMeshIndex;this.gcodeLineIndex.push(new Array),this.sps=new g('pcs'+t,1,e);var r=this.lines;this.sps.addPoints(this.lines.length,(function(e,t,i){r[i].renderParticle(e)})),this.sps.buildMeshAsync().then((e=>{e.material.pointSize=2}))}},{key:'createMesh',value:(n=P(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.renderVersion===oe.Line||this.renderVersion===oe.Point?r=new $(t,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex):this.renderVersion===oe.Block?r=this.highQualityExtrusion?new X(t,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex):new J(t,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex):this.renderVersion===oe.Voxel&&(r=new _(t,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.voxelWidth,this.voxelHeight)),r.progressColor=this.progressColor,r.vertexAlpha=this.vertexAlpha,this.renderInstances.push(r),e.next=6,r.render(this.lines);case 6:this.lines=[],this.scene.render();case 8:case'end':return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:'chunk',value:function(e,t){for(var r=[],i=0,s=e.length;i<s;i+=t)r.push(e.slice(i,i+t));return r}},{key:'createTravelLines',value:(r=P(regeneratorRuntime.mark((function e(t){var r,i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.chunk(this.travels,2e4),i=0;case 2:if(!(i<r.length)){e.next=12;break}return(s=new $(t,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex)).travels=!0,s.meshIndex=this.meshIndex+1e3,e.next=8,s.render(r[i]);case 8:this.renderInstances.push(s);case 9:i++,e.next=2;break;case 12:this.travels=[];case 13:case'end':return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:'updateFilePosition',value:function(e){this.renderInstances.forEach((t=>t.updateFilePosition(e))),this.doUpdate()}},{key:'doFinalPass',value:function(){var e=this;this.liveTracking=!0,this.gcodeFilePosition=Number.MAX_VALUE,setTimeout((()=>{e.liveTracking=!1}),this.refreshTime+200)}},{key:'updateMesh',value:function(){1===this.renderVersion?console.log('Version 1'):2===this.renderVersion&&console.log('Version 2')}},{key:'unregisterEvents',value:function(){for(var e=0;e<this.renderFuncs.length;e++)this.scene.unregisterBeforeRender(this.renderFuncs[e]),delete this.renderFuncs[e];this.renderFuncs=[];for(var t=0;t<this.renderInstances.length;t++)delete this.renderInstances[t];this.renderInstances=[]}},{key:'setLiveTracking',value:function(e){this.liveTracking=e}},{key:'setColorMode',value:function(e){e||(this.colorMode=ae.Color),localStorage.setItem('processorColorMode',e),this.colorMode=e}},{key:'updateMinFeedColor',value:function(e){localStorage.setItem('minFeedColor',e),this.minFeedColorString=e,this.minFeedColor=i.FromHexString(e.padEnd(9,'F'))}},{key:'updateMaxFeedColor',value:function(e){localStorage.setItem('maxFeedColor',e),this.maxFeedColorString=e,this.maxFeedColor=i.FromHexString(e.padEnd(9,'F'))}},{key:'updateColorRate',value:function(e,t){localStorage.setItem('minColorRate',e),localStorage.setItem('maxColorRate',t),this.minColorRate=e,this.maxColorRate=t}},{key:'updateForceWireMode',value:function(e){this.forceWireMode=e,localStorage.setItem('forceWireMode',e)}},{key:'setLiveTrackingShowSolid',value:function(e){this.liveTrackingShowSolid=e,localStorage.setItem('showSolid',e)}},{key:'setAlpha',value:function(e){this.vertexAlpha=e}},{key:'resetTools',value:function(){this.tools=new Array}},{key:'addTool',value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:W.Extruder,s=new U;s.color=i.FromHexString(e.padEnd(9,'F')),s.diameter=t,s.toolType=r,this.tools.push(s)}},{key:'updateTool',value:function(e,t,r){r<this.tools.length&&(this.tools[r].color=i.FromHexString(e.padEnd(9,'F')),this.tools[r].diameter=t)}},{key:'forceRedraw',value:function(){for(var e=0;e<this.renderInstances.length;e++)this.renderInstances[e].forceRedraw=!0;this.doUpdate()}},{key:'useHighQualityExtrusion',value:function(e){this.highQualityExtrusion=e}},{key:'setVoxelMode',value:function(e){this.forceVoxels=e}},{key:'useSpecularColor',value:function(e){var t=e?new s(.4,.4,.4):new s(0,0,0);this.specularColor=t,this.renderInstances.forEach((e=>e.material.specularColor=t)),this.scene&&this.scene.render(!0,!0)}},{key:'cancel',value:(t=P(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.cancelLoad=!0,e.next=3,this.pauseProcessing();case 3:case'end':return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),he=0,ue=1,ce=function(){function e(t){S(this,e),this.buildVolume={x:{min:0,max:100},y:{min:0,max:100},z:{min:0,max:100}};var r=localStorage.getItem('buildVolume');null!==r&&(this.buildVolume=JSON.parse(r)),this.renderMode=Number.parseInt(localStorage.getItem('renderBedMode')),this.renderMode||(this.renderMode=he),this.bedMesh,this.isDelta=!1,this.scene=t,this.registerClipIgnore=()=>{},this.bedLineColor='#0000FF',this.getBedColor()||this.setBedColor('#0000FF'),this.planeMaterial=this.buildGridMaterial(),this.boxMaterial=new f('bedBoxMaterial',this.scene),this.boxMaterial.alpha=0,this.debug=!1}return I(e,[{key:'setRenderMode',value:function(e){this.renderMode=e,localStorage.setItem('renderBedMode',this.renderMode),this.bedMesh&&(this.scene.removeMesh(this.bedMesh),this.bedMesh.dispose(!1,!0)),this.buildBed(),this.scene.render()}},{key:'buildBed',value:function(){if(!this.debug){if(this.bedMesh&&this.bedMesh.isDisposed()&&(this.bedMesh=null),this.bedMesh)return this.bedMesh;switch(this.renderMode){case he:this.buildFlatBed();break;case ue:this.buildBox()}return this.bedMesh}}},{key:'setDelta',value:function(e){this.isDelta=e,this.setRenderMode(this.renderMode)}},{key:'buildFlatBed',value:function(){var e=this.getCenter(),t=this.getSize();if(this.isDelta){var r=Math.abs(this.buildVolume.x.max-this.buildVolume.x.min)/2;this.bedMesh=u.CreateDisc('BuildPlate',{radius:r},this.scene),this.bedMesh.rotationQuaternion=new a.RotationAxis(new o(1,0,0),Math.PI/2),this.bedMesh.material=this.planeMaterial}else{var i=t.x,s=t.y;this.bedMesh=u.CreatePlane('BuildPlate',{width:i,height:s},this.scene),this.bedMesh.material=this.planeMaterial,this.bedMesh.rotationQuaternion=new a.RotationAxis(new o(1,0,0),Math.PI/2),this.bedMesh.translate(new o(e.x,0,e.y),1,l.WORLD)}this.registerClipIgnore(this.bedMesh)}},{key:'getCenter',value:function(){return{x:(this.buildVolume.x.max+this.buildVolume.x.min)/2,y:(this.buildVolume.y.max+this.buildVolume.y.min)/2,z:(this.buildVolume.z.max+this.buildVolume.z.min)/2}}},{key:'getSize',value:function(){return{x:Math.abs(this.buildVolume.x.max-this.buildVolume.x.min),y:Math.abs(this.buildVolume.y.max-this.buildVolume.y.min),z:Math.abs(this.buildVolume.z.max-this.buildVolume.z.min)}}},{key:'buildBox',value:function(){var e=this,t=this.getSize(),r=this.getCenter();if(this.isDelta){this.bedMesh=u.CreateCylinder('bed',{diameterTop:t.x,diameterBottom:t.x,height:t.z},this.scene),this.bedMesh.position.x=r.x,this.bedMesh.position.y=r.z,this.bedMesh.position.z=r.x,this.bedMesh.alpha=0,this.bedMesh.diffuseColor=new i(0,0,0,0),this.bedMesh.isPickable=!1,this.bedMesh.enableEdgesRendering(void 0,!0),this.bedMesh.renderingGroupId=2,this.scene.setRenderingAutoClearDepthStencil(2,!1,!1,!1),new v('hl',this.scene,{isStroke:!0,blurTextureSizeRatio:3}).addMesh(this.bedMesh,this.getBedColor4()),this.bedMesh.onBeforeRenderObservable.add((()=>{e.scene.getEngine().setColorWrite(!1)})),this.bedMesh.onAfterRenderObservable.add((()=>{e.scene.getEngine().setColorWrite(!0)})),this.registerClipIgnore(this.bedMesh)}else{this.bedMesh=u.CreateBox('bed',{width:t.x,depth:t.y,height:t.z},this.scene);var s=this.getCenter();this.bedMesh.position.x=s.x-this.buildVolume.x.min,this.bedMesh.position.y=s.z-this.buildVolume.z.min,this.bedMesh.position.z=s.y-this.buildVolume.y.min,this.bedMesh.diffuseColor=new i(0,0,0,0),this.bedMesh.enableEdgesRendering(),this.bedMesh.edgesWidth=100,this.bedMesh.material=this.boxMaterial,this.bedMesh.isPickable=!1,this.bedMesh.edgesColor=this.getBedColor4(),this.registerClipIgnore(this.bedMesh)}}},{key:'setVisibility',value:function(e){this.bedMesh&&this.bedMesh.setEnabled(e)}},{key:'commitBedSize',value:function(){localStorage.setItem('buildVolume',JSON.stringify(this.buildVolume)),this.setRenderMode(this.renderMode)}},{key:'buildGridMaterial',value:function(){var e=new y('bedMaterial',this.scene);return e.mainColor=new i(0,0,0,0),e.lineColor=s.FromHexString(this.getBedColor()),e.gridRatio=5,e.opacity=.8,e.majorUnitFrequency=10,e.minorUnitVisibility=.6,e.gridOffset=new o(0,0,0),e}},{key:'getBedColor',value:function(){return localStorage.getItem('bedLineColor')}},{key:'setBedColor',value:function(e){localStorage.setItem('bedLineColor',e),this.planeMaterial&&(this.planeMaterial=this.buildGridMaterial(),this.dispose(),this.buildBed(),this.scene.render())}},{key:'getBedColor4',value:function(){return i.FromHexString(this.getBedColor().padEnd(9,'F'))}},{key:'dispose',value:function(){this.bedMesh.dispose(!1,!0)}}]),e}(),de=function(){function e(t){S(this,e),this.scene=t,this.checkerBoard='iVBORw0KGgoAAAANSUhEUgAAAQEAAAEBCAIAAAD3joeqAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAALnSURBVHhe7dZBEYQwFAVBWBtogAv+IhIEsZd4yGG6L/lPwFRl31jqPM/neeZghd98oUoD1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjb7/ueJyscxzHGmIMV9u/75skK7/te1zUHK/gLUacB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA7Rt2x+drw1hSNi5LQAAAABJRU5ErkJggg==',this.xmark='data:image/png;base64,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',this.buildObjectMeshes=new Array,this.labels=new Array,this.labelSVGS=new Array,this.baseMaterial,this.highlightMaterial,this.cancelledMaterial,this.cancelledHighlightMaterial,this.showCancelObjects=!1,this.objectCallback,this.renderFailedCallback,this.labelCallback,this.registerClipIgnore,this.getMaxHeight,this.alphaLevel=.5,this.observableControls=null,this.showLabel=localStorage.getItem('showObjectLabels'),null===this.showLabel?this.showLabel=!0:this.showLabel=JSON.parse(this.showLabel),this.rebuildMaterials()}return I(e,[{key:'setBuildMaterial',value:function(e,t,r){r||(r=this.alphaLevel);var i=new f(e,this.scene);return i.diffuseColor=t,i.specularColor=new s(0,0,0),i.alpha=r,i.needAlphaTesting=()=>!0,i.separateCullingPass=!0,i.backFaceCulling=!0,i}},{key:'rebuildMaterials',value:function(){this.baseMaterial=this.setBuildMaterial('BuildObjectBaseMaterial',new i(.1,.5,.1),.25),this.highlightMaterial=this.setBuildMaterial('BuildObjectHighlightMateria',new s(.8,.8,.8)),this.cancelledMaterial=this.setBuildMaterial('BuildObjectHighlightMateria',new s(1,0,0),.4),this.cancelledHighlightMaterial=this.setBuildMaterial('BuildObjectHighlightMateria',new s(1,1,0),.6);var e=new x.CreateFromBase64String(this.xmark,'checkerboard',this.scene);this.cancelledMaterial.diffuseTexture=e,this.cancelledHighlightMaterial.diffuseTexture=e}},{key:'loadObjectBoundaries',value:function(e){if(this.rebuildMaterials(),this.buildObjectMeshes.length>0){for(var t=0;t<this.buildObjectMeshes.length;t++)this.buildObjectMeshes[t].dispose();this.labelSVGS.forEach((e=>window.URL.revokeObjectURL(e))),this.buildObjectMeshes=new Array,this.labels=new Array}if(e)for(var r=0;r<e.length;r++){var i=e[r],s=u.CreateTiledBox('OBJECTMESH:'+i.name,{pattern:m.CAP_ALL,alignVertical:m.TOP,alignHorizontal:m.LEFT,tileHeight:4,tileWidth:4,width:Math.abs(i.x[1]-i.x[0]),height:this.getMaxHeight()+10,depth:Math.abs(i.y[1]-i.y[0]),sideOrientation:m.FRONTSIDE},this.scene);s.position.x=(i.x[1]+i.x[0])/2,s.position.y=this.getMaxHeight()/2-4,s.position.z=(i.y[1]+i.y[0])/2,s.alphaIndex=5e6,i.index=r,s.metadata=i,s.enablePointerMoveEvents=!0,s.renderingGroupId=3,this.setObjectTexture(s),s.setEnabled(this.showCancelObjects),this.registerClipIgnore(s),this.buildObjectMeshes.push(s);var n=this.makeTextPlane(i.name,i.cancelled?'yellow':'white',20);n.position=new o(0,this.getMaxHeight()/2+10,0),n.isPickable=!1,n.metadata=i,n.parent=s,n.setEnabled(this.showLabel),this.labels.push(n)}}},{key:'makeTextPlane',value:function(e,t,r){var i=w.create('svg').attr('width',800).attr('height',200).attr('fill','none');i.append('text').attr('x',400).attr('y',100).attr('font-family','Verdana').attr('font-size','50px').attr('text-anchor','middle').attr('alignment-baseline','middle').attr('fill','black').attr('stroke',t).attr('stroke-width',2).attr('text-rendering','optimizeLegibility').text(e);var n=i.attr('title','test2').attr('version',1.1).attr('xmlns','http://www.w3.org/2000/svg').node(),o=(new XMLSerializer).serializeToString(n),a=new Blob(['<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+o],{type:'image/svg+xml'}),l=window.URL.createObjectURL(a);this.labelSVGS.push(l);var h=u.CreatePlane('TextPlane',{width:r,height:8},this.scene);return h.material=new f('TextPlaneMaterial',this.scene),h.material.backFaceCulling=!1,h.material.specularColor=new s(0,0,0),h.material.diffuseTexture=new x(l,this.scene),h.material.diffuseTexture.hasAlpha=!0,h.billboardMode=7,this.registerClipIgnore(h),h}},{key:'buildObservables',value:function(){var e=this;if(!this.observableControls){var t=0,r=!1,i=0;this.observableControls=this.scene.onPointerObservable.add((s=>{var n=s.pickInfo;switch(s.type){case C.POINTERDOWN:r=!0,i=Date.now();break;case C.POINTERUP:if(r=!1,Date.now()-i>200)return;e.handleClick(n);break;case C.POINTERMOVE:if(r||Date.now()-t<100)return;t=Date.now(),e.handlePointerMove(n)}}))}}},{key:'clearObservables',value:function(){this.observableControls&&(this.scene.onPointerObservable.remove(this.observableControls),this.observableControls=null)}},{key:'showObjectSelection',value:function(e){this.showCancelObjects=e,this.buildObjectMeshes.forEach((t=>t.setEnabled(e))),e?this.buildObservables():this.clearObservables()}},{key:'setObjectTexture',value:function(e){e.metadata.cancelled?(e.material=this.cancelledMaterial,e.enableEdgesRendering(),e.edgesWidth=15,e.edgesColor=new i(1,0,0,1)):(e.material=this.baseMaterial,e.enableEdgesRendering(),e.edgesWidth=15,e.edgesColor=new i(0,1,0,1))}},{key:'handleClick',value:function(e){this.showCancelObjects&&e.hit&&e.pickedMesh&&e.pickedMesh.name.includes('OBJECTMESH')&&this.objectCallback&&this.objectCallback(e.pickedMesh.metadata)}},{key:'handlePointerMove',value:function(e){var t=this;this.showCancelObjects&&(this.buildObjectMeshes.forEach((e=>t.setObjectTexture(e))),e.hit&&e.pickedMesh&&e.pickedMesh.name.includes('OBJECTMESH')?(e.pickedMesh.material=e.pickedMesh.metadata.cancelled?this.cancelledHighlightMaterial:this.highlightMaterial,this.labelCallback&&this.labelCallback(e.pickedMesh.metadata.name)):this.labelCallback&&this.labelCallback(''))}},{key:'showLabels',value:function(e){localStorage.setItem('showObjectLabels',e),this.showLabel=e,this.labels.forEach((t=>t.setEnabled(e)))}}]),e}(),pe=function(){function e(t){S(this,e),this.visible=localStorage.getItem('axesVisible'),null===this.visible?this.visible=!0:this.visible=JSON.parse(this.visible),this.scene=t,this.registerClipIgnore=()=>{},this.axesMesh,this.axesMeshPosition,this.size=50,this.debug=!1}return I(e,[{key:'show',value:function(e){localStorage.setItem('axesVisible',e),this.axesMesh&&this.axesMesh.setEnabled(e),this.scene.render()}},{key:'makeTextPlane',value:function(e,t,r){var i=new M('DynamicTexture',50,this.scene,!0);i.hasAlpha=!0,i.drawText(e,5,40,'bold 36px Arial',t,'transparent',!0);var n=m.CreatePlane('TextPlane',r,this.scene,!0);return n.material=new f('TextPlaneMaterial',this.scene),n.material.backFaceCulling=!1,n.material.specularColor=new s(0,0,0),n.material.diffuseTexture=i,n}},{key:'resize',value:function(e){this.size=e,this.axesMesh.dispose(!1,!0),this.render()}},{key:'render',value:function(e){var t=this;if(!this.debug)if(!this.axesMesh||this.axesMesh.isDisposed()){this.axesMesh=new m('axis'),this.registerClipIgnore(this.axesMesh);var r=m.CreateLines('axisX',[o.Zero(),new o(this.size,0,0),new o(.95*this.size,.05*this.size,0),new o(this.size,0,0),new o(.95*this.size,-.05*this.size,0)],this.scene);r.color=new s(1,0,0),r.parent=this.axesMesh;var i=this.makeTextPlane('X','red',this.size/10);i.position=new o(.9*this.size,.05*this.size,0),i.parent=this.axesMesh;var n=m.CreateLines('axisZ',[o.Zero(),new o(0,0,this.size),new o(0,-.05*this.size,.95*this.size),new o(0,0,this.size),new o(0,.05*this.size,.95*this.size)],this.scene);n.color=new s(0,1,0),n.parent=this.axesMesh;var a=this.makeTextPlane('Y','green',this.size/10);a.position=new o(0,.05*this.size,.9*this.size),a.parent=this.axesMesh;var l=m.CreateLines('axisY',[o.Zero(),new o(0,this.size,0),new o(-.05*this.size,.95*this.size,0),new o(0,this.size,0),new o(.05*this.size,.95*this.size,0)],this.scene);l.color=new s(0,0,1),l.parent=this.axesMesh;var h=this.makeTextPlane('Z','blue',this.size/10);h.position=new o(0,.9*this.size,-.05*this.size),h.parent=this.axesMesh,this.axesMesh.setEnabled(this.visible),this.axesMesh.getChildren().forEach((e=>t.registerClipIgnore(e))),e&&(this.axesMesh.position=e)}else e&&(this.axesMesh.position=e)}},{key:'dispose',value:function(){this.axesMesh&&this.axesMesh.dispose(!1,!0)}}]),e}(),ge=function(){function i(e){S(this,i),this.lastLoadKey='lastLoadFailed',this.fileData,this.fileSize=0,this.gcodeProcessor=new le,this.maxHeight=0,this.minHeight=0,this.sceneBackgroundColor='#000000',this.canvas=e,this.scene={},this.loading=!1,this.toolVisible=!1,this.toolCursor,this.toolCursorMesh,this.toolCursorVisible=!0,this.travelVisible=!1,this.debug=!1,this.zTopClipValue,this.zBottomClipValue,this.cancelHitTimer=0,this.pause=!1,this.cameraInertia='true'===localStorage.getItem('cameraInertia'),this.bed,this.buildObjects,this.axes,this.renderQuality=Number(localStorage.getItem('renderQuality')),void 0!==this.renderQuality&&null!==this.renderQuality||(this.renderQuality=1),this.renderTimeout=1e3}var n,a;return I(i,[{key:'getMaxHeight',value:function(){return this.maxHeight}},{key:'getMinHeight',value:function(){return this.minHeight}},{key:'setCameraType',value:function(e){this.scene.activeCamera=e?this.orbitCamera:this.flyCamera}},{key:'setZClipPlane',value:function(e,t){this.zTopClipValue=-e,this.zBottomClipValue=t,t>e&&(this.zTopClipValue=t+1),this.scene.clipPlane=new r(0,1,0,this.zTopClipValue),this.scene.clipPlane2=new r(0,-1,0,this.zBottomClipValue),this.scene.render()}},{key:'isArcRotateCameraStopped',value:function(e){return 0===e.inertialAlphaOffset&&0===e.inertialBetaOffset&&0===e.inertialRadiusOffset&&0===e.inertialPanningX&&0===e.inertialPanningY}},{key:'init',value:function(){var r=this;console.info('GCode Viewer - Sindarius - v2.1.17 '),this.engine=new e(this.canvas,!0,{doNotHandleContextLost:!0}),this.engine.enableOfflineSupport=!1,this.scene=new t(this.engine),this.debug,this.scene.clearColor=s.FromHexString(this.getBackgroundColor()),this.bed=new ce(this.scene),this.bed.registerClipIgnore=e=>{r.registerClipIgnore(e)};var i=this.bed.getCenter();this.orbitCamera=new d('Camera',Math.PI/2,2.356194,250,new o(i.x,-2,i.y),this.scene),this.orbitCamera.attachControl(!1),this.orbitCamera.invertRotation=!1,this.orbitCamera.attachControl(this.canvas,!1),this.orbitCamera.maxZ=1e5,this.orbitCamera.lowerRadiusLimit=10,this.updateCameraInertiaProperties();var n=new p('light2',new o(0,1,-1),this.scene);n.diffuse=new s(1,1,1),n.specular=new s(1,1,1),this.engine.runRenderLoop((()=>{r.pause||Date.now()-r.gcodeProcessor.lastUpdate>r.renderTimeout&&r.isArcRotateCameraStopped(r.orbitCamera)||(r.scene.render(!0,!0),n.position=r.scene.cameras[0].position)})),this.buildObjects=new de(this.scene),this.buildObjects.getMaxHeight=()=>r.gcodeProcessor.getMaxHeight(),this.buildObjects.registerClipIgnore=e=>{r.registerClipIgnore(e)},this.bed.buildBed(),this.axes=new pe(this.scene),this.axes.registerClipIgnore=e=>{r.registerClipIgnore(e)},this.axes.render(),this.resetCamera()}},{key:'resize',value:function(){this.engine.resize(),this.scene.render(!0,!0)}},{key:'refreshUI',value:function(){setTimeout((()=>{}),0)}},{key:'resetCamera',value:function(){var e=this.bed.getCenter(),t=this.bed.getSize();this.scene.activeCamera.alpha=Math.PI/2,this.scene.activeCamera.beta=2.356194,this.bed.isDelta?(this.scene.activeCamera.radius=e.x,this.scene.activeCamera.target=new o(e.x,-2,e.y),this.scene.activeCamera.position=new o(-t.x,t.z,-t.x)):(this.scene.activeCamera.radius=250,this.scene.activeCamera.target=new o(e.x,-2,e.y),this.scene.activeCamera.position=new o(-t.x/2,t.z,-t.y/2)),this.scene.render(!0,!0)}},{key:'lastLoadFailed',value:function(){return!!localStorage&&'true'===localStorage.getItem(this.lastLoadKey)}},{key:'setLoadFlag',value:function(){localStorage&&localStorage.setItem(this.lastLoadKey,'true')}},{key:'clearLoadFlag',value:function(){localStorage&&(localStorage.setItem(this.lastLoadKey,''),localStorage.removeItem(this.lastLoadKey))}},{key:'processFile',value:(a=P(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.clearScene(),this.refreshUI(),t?(this.fileData=t,this.fileSize=t.length):(this.fileData=0,this.fileSize=0),this.gcodeProcessor.setProgressColor(this.getProgressColor()),this.gcodeProcessor.scene=this.scene,this.lastLoadFailed()&&(console.error('Last rendering failed dropping to SBC quality'),this.updateRenderQuality(1),this.clearLoadFlag()),this.setLoadFlag(),e.next=9,this.gcodeProcessor.processGcodeFile(t,this.renderQuality);case 9:return this.clearLoadFlag(),e.next=12,this.gcodeProcessor.createMesh(this.scene);case 12:this.gcodeProcessor.loadingComplete(),this.maxHeight=this.gcodeProcessor.getMaxHeight(),this.minHeight=this.gcodeProcessor.getMinHeight(),this.toggleTravels(this.travelVisible),this.setCursorVisiblity(this.toolCursorVisible);case 17:case'end':return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:'toggleTravels',value:function(e){var t,r=function(e,t){var r='undefined'!=typeof Symbol&&e[Symbol.iterator]||e['@@iterator'];if(!r){if(Array.isArray(e)||(r=H(e))||t&&e&&'number'==typeof e.length){r&&(e=r);var i=0,s=()=>{};return{s,n:()=>i>=e.length?{done:!0}:{done:!1,value:e[i++]},e:e=>{throw e},f:s}}throw new TypeError('Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.')}var n,o=!0,a=!1;return{s:()=>{r=r.call(e)},n:()=>{var e=r.next();return o=e.done,e},e:e=>{a=!0,n=e},f:()=>{try{o||null==r.return||r.return()}finally{if(a)throw n}}}}(this.scene.meshes);try{for(r.s();!(t=r.n()).done;){var i=t.value;'travels'===i.name&&(i.isVisible=e)}}catch(e){r.e(e)}finally{r.f()}this.travelVisible=e,this.scene.render(!0,!0)}},{key:'getProgressColor',value:function(){var e=localStorage.getItem('progressColor');return null===e&&(e='#FFFFFF'),e}},{key:'setProgressColor',value:function(e){localStorage.setItem('progressColor',e),this.gcodeProcessor.setProgressColor(e)}},{key:'getBackgroundColor',value:function(){var e=localStorage.getItem('sceneBackgroundColor');return null===e&&(e='#000000'),e}},{key:'setBackgroundColor',value:function(e){null!==this.scene&&void 0!==this.scene&&(e.length>7&&(e=e.substring(0,7)),this.scene.clearColor=s.FromHexString(e),this.scene.render()),localStorage.setItem('sceneBackgroundColor',e)}},{key:'clearScene',value:function(e){this.fileData&&e&&(this.fileData=''),this.gcodeProcessor.unregisterEvents();for(var t=this.scene.meshes.length-1;t>=0;t--){var r=this.scene.meshes[t];r&&this.debug&&console.log('Disposing '.concat(r.name)),this.scene.removeMesh(r),r&&'function'==typeof r.dispose&&r.dispose(!1,!0)}for(var i=this.scene.materials.length-1;i>=0;i--){var s=this.scene.materials[i];'solidMaterial'===s.name&&(s&&this.debug&&console.log('Disposing '.concat(s.name)),this.scene.removeMaterial(s),s&&'function'==typeof s.dispose&&s.dispose(!1,!0))}this.toolCursor&&(this.toolCursor.dispose(!1,!0),this.toolCursor=void 0),this.buildtoolCursor(),this.bed.buildBed(),this.axes.render()}},{key:'reload',value:(n=P(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.clearScene(),e.next=3,this.processFile(this.fileData);case 3:case'end':return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:'getRenderMode',value:function(){return this.gcodeProcessor.renderMode}},{key:'setCursorVisiblity',value:function(e){void 0!==this.scene&&(void 0===this.toolCursor&&this.buildtoolCursor(),this.toolCursorMesh.isVisible=e,this.toolCursorVisible=e,this.scene.render())}},{key:'updateToolPosition',value:function(e){var t=0,r=0,i=0;this.buildtoolCursor();for(var s=0;s<e.length;s++){switch(e[s].axes){case'X':t=e[s].position;break;case'Y':r=e[s].position;break;case'Z':i=e[s].position*(this.gcodeProcessor.spreadLines?this.gcodeProcessor.spreadLineAmount:1)}this.toolCursor.setAbsolutePosition(new o(t,i,r)),this.toolCursorMesh.isVisible&&this.scene.render()}}},{key:'buildtoolCursor',value:function(){void 0===this.toolCursor&&(this.toolCursor=new c('toolCursorContainer'),this.toolCursorMesh=u.CreateCylinder('toolCursorMesh',{diameterTop:0,diameterBottom:1},this.scene),this.toolCursorMesh.parent=this.toolCursor,this.toolCursorMesh.position=new o(0,3,0),this.toolCursorMesh.rotate(h.X,Math.PI,l.LOCAL),this.toolCursorMesh.scaling=new o(3,3,3),this.toolCursorMesh.isVisible=this.toolCursorVisible,this.toolCursorMesh.renderingGroupId=2,this.registerClipIgnore(this.toolCursorMesh))}},{key:'updateRenderQuality',value:function(e){this.renderQuality=e,localStorage&&localStorage.setItem('renderQuality',e)}},{key:'registerClipIgnore',value:function(e){var t=this;null!=e&&(e.onBeforeRenderObservable.add((()=>{t.scene.clipPlane=null,t.scene.clipPlane2=null})),e.onAfterRenderObservable.add((()=>{t.scene.clipPlane=new r(0,1,0,t.zTopClipValue),t.scene.clipPlane2=new r(0,-1,0,t.zBottomClipValue)})))}},{key:'updateCameraInertiaProperties',value:function(){this.cameraInertia?(this.orbitCamera.speed=2,this.orbitCamera.inertia=.9,this.orbitCamera.panningInertia=.9,this.orbitCamera.inputs.attached.keyboard.angularSpeed=.005,this.orbitCamera.inputs.attached.keyboard.zoomingSensibility=2,this.orbitCamera.inputs.attached.keyboard.panningSensibility=2,this.orbitCamera.angularSensibilityX=1e3,this.orbitCamera.angularSensibilityY=1e3,this.orbitCamera.panningSensibility=10,this.orbitCamera.wheelPrecision=1):(this.orbitCamera.speed=500,this.orbitCamera.inertia=0,this.orbitCamera.panningInertia=0,this.orbitCamera.inputs.attached.keyboard.angularSpeed=.05,this.orbitCamera.inputs.attached.keyboard.zoomingSensibility=.5,this.orbitCamera.inputs.attached.keyboard.panningSensibility=.5,this.orbitCamera.angularSensibilityX=200,this.orbitCamera.angularSensibilityY=200,this.orbitCamera.panningSensibility=2,this.orbitCamera.wheelPrecision=.25)}},{key:'setCameraInertia',value:function(e){this.cameraInertia=e,localStorage.setItem('cameraInertia',e),this.updateCameraInertiaProperties()}},{key:'forceRender',value:function(){this.scene&&this.scene.render(!0,!0)}}]),i}();export{pe as Axes,de as BuildObjects,ae as ColorMode,oe as RenderMode,U as Tool,W as ToolType,ge as default};
